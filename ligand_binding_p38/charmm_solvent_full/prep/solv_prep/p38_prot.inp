* CHARMM input file for Multi-Site lambda-dynamics
* generated by msld_py_prep (JV,LC) for ALF (RLH)
*
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!  Multi-Site Lambda Dynamics 
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

set fnex = 5.5 
!!set sysname = p38
set builddir = prep
set box = 92
set pmegrid = 96
set temp = 298.15
set ligseg = lig
set resnum = 1

! perturbation variables
set nsites = 2 
set nsubs1 = 16 
set nsubs2 = 12 
set nblocks = 28 

bomblev -2

!! Read in toppar stream file
stream @builddir/toppar.str

read rtf append card name @builddir/core.rtf
read param flex append card name @builddir/full_ligand.prm

!! !! Reads coordinates and pdb file for the protein
!! read sequ pdb name @builddir/protein.pdb
!! generate SEGID first NTER last CTER setup warn
!! read coor pdb resid name @builddir/protein.pdb
!! 
!! ic generate
!! ic param
!! ic build 
!! hbuild sele hydrogen end
!! auto angle dihe

!! Reads coordinates and pdb file for the ligand
read sequ pdb name @builddir/core.pdb
generate @ligseg setup
read coor pdb resid name @builddir/core.pdb

!! Read in the ligand patch rtf files
read rtf append card name @builddir/site1_sub1_pres.rtf
read rtf append card name @builddir/site1_sub2_pres.rtf
read rtf append card name @builddir/site1_sub3_pres.rtf
read rtf append card name @builddir/site1_sub4_pres.rtf
read rtf append card name @builddir/site1_sub5_pres.rtf
read rtf append card name @builddir/site1_sub6_pres.rtf
read rtf append card name @builddir/site1_sub7_pres.rtf
read rtf append card name @builddir/site1_sub8_pres.rtf
read rtf append card name @builddir/site1_sub9_pres.rtf
read rtf append card name @builddir/site1_sub10_pres.rtf
read rtf append card name @builddir/site1_sub11_pres.rtf
read rtf append card name @builddir/site1_sub12_pres.rtf
read rtf append card name @builddir/site1_sub13_pres.rtf
read rtf append card name @builddir/site1_sub14_pres.rtf
read rtf append card name @builddir/site1_sub15_pres.rtf
read rtf append card name @builddir/site1_sub16_pres.rtf
read rtf append card name @builddir/site2_sub1_pres.rtf
read rtf append card name @builddir/site2_sub2_pres.rtf
read rtf append card name @builddir/site2_sub3_pres.rtf
read rtf append card name @builddir/site2_sub4_pres.rtf
read rtf append card name @builddir/site2_sub5_pres.rtf
read rtf append card name @builddir/site2_sub6_pres.rtf
read rtf append card name @builddir/site2_sub7_pres.rtf
read rtf append card name @builddir/site2_sub8_pres.rtf
read rtf append card name @builddir/site2_sub9_pres.rtf
read rtf append card name @builddir/site2_sub10_pres.rtf
read rtf append card name @builddir/site2_sub11_pres.rtf
read rtf append card name @builddir/site2_sub12_pres.rtf

!! Read in the ligand fragment pdb files
ic generate

patch p1_1 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub1_frag.pdb
ic param
ic build

patch p1_2 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub2_frag.pdb
ic param
ic build

patch p1_3 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub3_frag.pdb
ic param
ic build

patch p1_4 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub4_frag.pdb
ic param
ic build

patch p1_5 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub5_frag.pdb
ic param
ic build

patch p1_6 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub6_frag.pdb
ic param
ic build

patch p1_7 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub7_frag.pdb
ic param
ic build

patch p1_8 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub8_frag.pdb
ic param
ic build

patch p1_9 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub9_frag.pdb
ic param
ic build

patch p1_10 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub10_frag.pdb
ic param
ic build

patch p1_11 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub11_frag.pdb
ic param
ic build

patch p1_12 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub12_frag.pdb
ic param
ic build

patch p1_13 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub13_frag.pdb
ic param
ic build

patch p1_14 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub14_frag.pdb
ic param
ic build

patch p1_15 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub15_frag.pdb
ic param
ic build

patch p1_16 @ligseg @resnum setup
read coor pdb resid name @builddir/site1_sub16_frag.pdb
ic param
ic build

patch p2_1 @ligseg @resnum setup
read coor pdb resid name @builddir/site2_sub1_frag.pdb
ic param
ic build

patch p2_2 @ligseg @resnum setup
read coor pdb resid name @builddir/site2_sub2_frag.pdb
ic param
ic build

patch p2_3 @ligseg @resnum setup
read coor pdb resid name @builddir/site2_sub3_frag.pdb
ic param
ic build

patch p2_4 @ligseg @resnum setup
read coor pdb resid name @builddir/site2_sub4_frag.pdb
ic param
ic build

patch p2_5 @ligseg @resnum setup
read coor pdb resid name @builddir/site2_sub5_frag.pdb
ic param
ic build

patch p2_6 @ligseg @resnum setup
read coor pdb resid name @builddir/site2_sub6_frag.pdb
ic param
ic build

patch p2_7 @ligseg @resnum setup
read coor pdb resid name @builddir/site2_sub7_frag.pdb
ic param
ic build

patch p2_8 @ligseg @resnum setup
read coor pdb resid name @builddir/site2_sub8_frag.pdb
ic param
ic build

patch p2_9 @ligseg @resnum setup
read coor pdb resid name @builddir/site2_sub9_frag.pdb
ic param
ic build

patch p2_10 @ligseg @resnum setup
read coor pdb resid name @builddir/site2_sub10_frag.pdb
ic param
ic build

patch p2_11 @ligseg @resnum setup
read coor pdb resid name @builddir/site2_sub11_frag.pdb
ic param
ic build

patch p2_12 @ligseg @resnum setup
read coor pdb resid name @builddir/site2_sub12_frag.pdb
ic param
ic build

!! Read in LonePair sites (if applicable)
stream @builddir/lpsites.inp

!! Define MSLD substituent selections
define site1_sub1 - 
   select ( - 
   atom @ligseg @resnum C025 .or. -
   atom @ligseg @resnum H028 .or. -
   atom @ligseg @resnum C026 .or. -
   atom @ligseg @resnum H031 .or. -
   atom @ligseg @resnum H032 .or. -
   atom @ligseg @resnum C027 .or. -
   atom @ligseg @resnum H033 .or. -
   atom @ligseg @resnum H034 .or. -
   atom @ligseg @resnum C029 .or. -
   atom @ligseg @resnum H036 .or. -
   atom @ligseg @resnum H037 .or. -
   atom @ligseg @resnum C030 .or. -
   atom @ligseg @resnum H038 .or. -
   atom @ligseg @resnum H039 .or. -
   atom @ligseg @resnum O035 .or. -
   atom @ligseg @resnum N040 .or. -
   atom @ligseg @resnum H041 .or. -
   none ) end

define site1_sub2 - 
   select ( - 
   atom @ligseg @resnum C042 .or. -
   atom @ligseg @resnum H045 .or. -
   atom @ligseg @resnum C043 .or. -
   atom @ligseg @resnum H048 .or. -
   atom @ligseg @resnum H049 .or. -
   atom @ligseg @resnum C044 .or. -
   atom @ligseg @resnum H050 .or. -
   atom @ligseg @resnum H051 .or. -
   atom @ligseg @resnum O046 .or. -
   atom @ligseg @resnum H052 .or. -
   atom @ligseg @resnum O047 .or. -
   atom @ligseg @resnum H053 .or. -
   atom @ligseg @resnum N054 .or. -
   atom @ligseg @resnum H055 .or. -
   none ) end

define site1_sub3 - 
   select ( - 
   atom @ligseg @resnum C056 .or. -
   atom @ligseg @resnum H059 .or. -
   atom @ligseg @resnum C057 .or. -
   atom @ligseg @resnum H062 .or. -
   atom @ligseg @resnum H063 .or. -
   atom @ligseg @resnum C058 .or. -
   atom @ligseg @resnum H064 .or. -
   atom @ligseg @resnum H065 .or. -
   atom @ligseg @resnum C060 .or. -
   atom @ligseg @resnum H068 .or. -
   atom @ligseg @resnum H069 .or. -
   atom @ligseg @resnum C061 .or. -
   atom @ligseg @resnum H070 .or. -
   atom @ligseg @resnum H071 .or. -
   atom @ligseg @resnum O066 .or. -
   atom @ligseg @resnum H072 .or. -
   atom @ligseg @resnum O067 .or. -
   atom @ligseg @resnum H073 .or. -
   atom @ligseg @resnum N074 .or. -
   atom @ligseg @resnum H075 .or. -
   none ) end

define site1_sub4 - 
   select ( - 
   atom @ligseg @resnum C076 .or. -
   atom @ligseg @resnum H078 .or. -
   atom @ligseg @resnum H079 .or. -
   atom @ligseg @resnum C077 .or. -
   atom @ligseg @resnum H081 .or. -
   atom @ligseg @resnum H082 .or. -
   atom @ligseg @resnum S080 .or. -
   atom @ligseg @resnum O083 .or. -
   atom @ligseg @resnum O084 .or. -
   atom @ligseg @resnum C085 .or. -
   atom @ligseg @resnum H086 .or. -
   atom @ligseg @resnum H087 .or. -
   atom @ligseg @resnum H088 .or. -
   atom @ligseg @resnum N089 .or. -
   atom @ligseg @resnum H090 .or. -
   none ) end

define site1_sub5 - 
   select ( - 
   atom @ligseg @resnum C091 .or. -
   atom @ligseg @resnum H094 .or. -
   atom @ligseg @resnum C092 .or. -
   atom @ligseg @resnum H096 .or. -
   atom @ligseg @resnum H097 .or. -
   atom @ligseg @resnum H098 .or. -
   atom @ligseg @resnum C093 .or. -
   atom @ligseg @resnum H099 .or. -
   atom @ligseg @resnum H100 .or. -
   atom @ligseg @resnum S095 .or. -
   atom @ligseg @resnum O101 .or. -
   atom @ligseg @resnum O102 .or. -
   atom @ligseg @resnum C103 .or. -
   atom @ligseg @resnum H104 .or. -
   atom @ligseg @resnum H105 .or. -
   atom @ligseg @resnum H106 .or. -
   atom @ligseg @resnum N107 .or. -
   atom @ligseg @resnum H108 .or. -
   none ) end

define site1_sub6 - 
   select ( - 
   atom @ligseg @resnum C109 .or. -
   atom @ligseg @resnum H112 .or. -
   atom @ligseg @resnum C110 .or. -
   atom @ligseg @resnum H114 .or. -
   atom @ligseg @resnum H115 .or. -
   atom @ligseg @resnum H116 .or. -
   atom @ligseg @resnum C111 .or. -
   atom @ligseg @resnum H117 .or. -
   atom @ligseg @resnum H118 .or. -
   atom @ligseg @resnum S113 .or. -
   atom @ligseg @resnum O119 .or. -
   atom @ligseg @resnum O120 .or. -
   atom @ligseg @resnum C121 .or. -
   atom @ligseg @resnum H122 .or. -
   atom @ligseg @resnum H123 .or. -
   atom @ligseg @resnum H124 .or. -
   atom @ligseg @resnum N125 .or. -
   atom @ligseg @resnum H126 .or. -
   none ) end

define site1_sub7 - 
   select ( - 
   atom @ligseg @resnum C127 .or. -
   atom @ligseg @resnum H130 .or. -
   atom @ligseg @resnum C128 .or. -
   atom @ligseg @resnum H133 .or. -
   atom @ligseg @resnum H134 .or. -
   atom @ligseg @resnum C129 .or. -
   atom @ligseg @resnum H135 .or. -
   atom @ligseg @resnum H136 .or. -
   atom @ligseg @resnum C131 .or. -
   atom @ligseg @resnum H138 .or. -
   atom @ligseg @resnum H139 .or. -
   atom @ligseg @resnum C132 .or. -
   atom @ligseg @resnum H140 .or. -
   atom @ligseg @resnum H141 .or. -
   atom @ligseg @resnum N137 .or. -
   atom @ligseg @resnum C142 .or. -
   atom @ligseg @resnum O143 .or. -
   atom @ligseg @resnum C144 .or. -
   atom @ligseg @resnum H145 .or. -
   atom @ligseg @resnum H146 .or. -
   atom @ligseg @resnum H147 .or. -
   atom @ligseg @resnum N148 .or. -
   atom @ligseg @resnum H149 .or. -
   none ) end

define site1_sub8 - 
   select ( - 
   atom @ligseg @resnum C150 .or. -
   atom @ligseg @resnum H153 .or. -
   atom @ligseg @resnum C151 .or. -
   atom @ligseg @resnum H156 .or. -
   atom @ligseg @resnum H157 .or. -
   atom @ligseg @resnum C152 .or. -
   atom @ligseg @resnum H158 .or. -
   atom @ligseg @resnum H159 .or. -
   atom @ligseg @resnum C154 .or. -
   atom @ligseg @resnum H161 .or. -
   atom @ligseg @resnum H162 .or. -
   atom @ligseg @resnum C155 .or. -
   atom @ligseg @resnum H163 .or. -
   atom @ligseg @resnum H164 .or. -
   atom @ligseg @resnum C160 .or. -
   atom @ligseg @resnum H166 .or. -
   atom @ligseg @resnum O165 .or. -
   atom @ligseg @resnum H167 .or. -
   atom @ligseg @resnum N168 .or. -
   atom @ligseg @resnum H169 .or. -
   none ) end

define site1_sub9 - 
   select ( - 
   atom @ligseg @resnum C170 .or. -
   atom @ligseg @resnum H173 .or. -
   atom @ligseg @resnum C171 .or. -
   atom @ligseg @resnum H176 .or. -
   atom @ligseg @resnum H177 .or. -
   atom @ligseg @resnum C172 .or. -
   atom @ligseg @resnum H178 .or. -
   atom @ligseg @resnum H179 .or. -
   atom @ligseg @resnum C174 .or. -
   atom @ligseg @resnum H181 .or. -
   atom @ligseg @resnum H182 .or. -
   atom @ligseg @resnum C175 .or. -
   atom @ligseg @resnum H183 .or. -
   atom @ligseg @resnum H184 .or. -
   atom @ligseg @resnum S180 .or. -
   atom @ligseg @resnum O185 .or. -
   atom @ligseg @resnum O186 .or. -
   atom @ligseg @resnum N187 .or. -
   atom @ligseg @resnum H188 .or. -
   none ) end

define site1_sub10 - 
   select ( - 
   atom @ligseg @resnum C189 .or. -
   atom @ligseg @resnum H192 .or. -
   atom @ligseg @resnum C190 .or. -
   atom @ligseg @resnum H195 .or. -
   atom @ligseg @resnum H196 .or. -
   atom @ligseg @resnum H197 .or. -
   atom @ligseg @resnum N191 .or. -
   atom @ligseg @resnum N193 .or. -
   atom @ligseg @resnum C194 .or. -
   atom @ligseg @resnum H200 .or. -
   atom @ligseg @resnum N198 .or. -
   atom @ligseg @resnum N199 .or. -
   atom @ligseg @resnum N201 .or. -
   atom @ligseg @resnum H202 .or. -
   none ) end

define site1_sub11 - 
   select ( - 
   atom @ligseg @resnum C203 .or. -
   atom @ligseg @resnum H206 .or. -
   atom @ligseg @resnum C204 .or. -
   atom @ligseg @resnum H209 .or. -
   atom @ligseg @resnum H210 .or. -
   atom @ligseg @resnum H211 .or. -
   atom @ligseg @resnum N205 .or. -
   atom @ligseg @resnum N207 .or. -
   atom @ligseg @resnum C208 .or. -
   atom @ligseg @resnum H214 .or. -
   atom @ligseg @resnum N212 .or. -
   atom @ligseg @resnum N213 .or. -
   atom @ligseg @resnum N215 .or. -
   atom @ligseg @resnum H216 .or. -
   none ) end

define site1_sub12 - 
   select ( - 
   atom @ligseg @resnum C217 .or. -
   atom @ligseg @resnum H218 .or. -
   atom @ligseg @resnum H219 .or. -
   atom @ligseg @resnum H220 .or. -
   atom @ligseg @resnum N221 .or. -
   atom @ligseg @resnum H222 .or. -
   none ) end

define site1_sub13 - 
   select ( - 
   atom @ligseg @resnum C223 .or. -
   atom @ligseg @resnum H226 .or. -
   atom @ligseg @resnum C224 .or. -
   atom @ligseg @resnum H227 .or. -
   atom @ligseg @resnum H228 .or. -
   atom @ligseg @resnum H229 .or. -
   atom @ligseg @resnum C225 .or. -
   atom @ligseg @resnum H230 .or. -
   atom @ligseg @resnum H231 .or. -
   atom @ligseg @resnum H232 .or. -
   atom @ligseg @resnum N233 .or. -
   atom @ligseg @resnum H234 .or. -
   none ) end

define site1_sub14 - 
   select ( - 
   atom @ligseg @resnum C235 .or. -
   atom @ligseg @resnum H238 .or. -
   atom @ligseg @resnum C236 .or. -
   atom @ligseg @resnum H241 .or. -
   atom @ligseg @resnum H242 .or. -
   atom @ligseg @resnum C237 .or. -
   atom @ligseg @resnum H243 .or. -
   atom @ligseg @resnum H244 .or. -
   atom @ligseg @resnum C239 .or. -
   atom @ligseg @resnum H245 .or. -
   atom @ligseg @resnum H246 .or. -
   atom @ligseg @resnum O240 .or. -
   atom @ligseg @resnum N247 .or. -
   atom @ligseg @resnum H248 .or. -
   none ) end

define site1_sub15 - 
   select ( - 
   atom @ligseg @resnum C249 .or. -
   atom @ligseg @resnum H251 .or. -
   atom @ligseg @resnum H252 .or. -
   atom @ligseg @resnum C250 .or. -
   atom @ligseg @resnum C253 .or. -
   atom @ligseg @resnum H256 .or. -
   atom @ligseg @resnum H257 .or. -
   atom @ligseg @resnum H258 .or. -
   atom @ligseg @resnum C254 .or. -
   atom @ligseg @resnum H259 .or. -
   atom @ligseg @resnum H260 .or. -
   atom @ligseg @resnum H261 .or. -
   atom @ligseg @resnum O255 .or. -
   atom @ligseg @resnum H262 .or. -
   atom @ligseg @resnum N263 .or. -
   atom @ligseg @resnum H264 .or. -
   none ) end

define site1_sub16 - 
   select ( - 
   atom @ligseg @resnum C265 .or. -
   atom @ligseg @resnum C266 .or. -
   atom @ligseg @resnum H270 .or. -
   atom @ligseg @resnum H271 .or. -
   atom @ligseg @resnum H272 .or. -
   atom @ligseg @resnum C267 .or. -
   atom @ligseg @resnum H273 .or. -
   atom @ligseg @resnum H274 .or. -
   atom @ligseg @resnum H275 .or. -
   atom @ligseg @resnum C268 .or. -
   atom @ligseg @resnum H276 .or. -
   atom @ligseg @resnum H277 .or. -
   atom @ligseg @resnum O269 .or. -
   atom @ligseg @resnum H278 .or. -
   atom @ligseg @resnum N279 .or. -
   atom @ligseg @resnum H280 .or. -
   none ) end

define site2_sub1 - 
   select ( - 
   atom @ligseg @resnum C281 .or. -
   atom @ligseg @resnum H282 .or. -
   atom @ligseg @resnum H283 .or. -
   atom @ligseg @resnum H284 .or. -
   atom @ligseg @resnum N285 .or. -
   none ) end

define site2_sub2 - 
   select ( - 
   atom @ligseg @resnum N287 .or. -
   atom @ligseg @resnum H286 .or. -
   none ) end

define site2_sub3 - 
   select ( - 
   atom @ligseg @resnum C288 .or. -
   atom @ligseg @resnum H290 .or. -
   atom @ligseg @resnum H291 .or. -
   atom @ligseg @resnum C289 .or. -
   atom @ligseg @resnum H292 .or. -
   atom @ligseg @resnum H293 .or. -
   atom @ligseg @resnum H294 .or. -
   atom @ligseg @resnum N295 .or. -
   none ) end

define site2_sub4 - 
   select ( - 
   atom @ligseg @resnum C296 .or. -
   atom @ligseg @resnum H299 .or. -
   atom @ligseg @resnum C297 .or. -
   atom @ligseg @resnum H300 .or. -
   atom @ligseg @resnum H301 .or. -
   atom @ligseg @resnum C298 .or. -
   atom @ligseg @resnum H302 .or. -
   atom @ligseg @resnum H303 .or. -
   atom @ligseg @resnum N304 .or. -
   none ) end

define site2_sub5 - 
   select ( - 
   atom @ligseg @resnum C305 .or. -
   atom @ligseg @resnum H307 .or. -
   atom @ligseg @resnum H308 .or. -
   atom @ligseg @resnum C306 .or. -
   atom @ligseg @resnum H310 .or. -
   atom @ligseg @resnum H311 .or. -
   atom @ligseg @resnum C309 .or. -
   atom @ligseg @resnum H313 .or. -
   atom @ligseg @resnum H314 .or. -
   atom @ligseg @resnum O312 .or. -
   atom @ligseg @resnum H315 .or. -
   atom @ligseg @resnum N316 .or. -
   none ) end

define site2_sub6 - 
   select ( - 
   atom @ligseg @resnum C317 .or. -
   atom @ligseg @resnum H319 .or. -
   atom @ligseg @resnum H320 .or. -
   atom @ligseg @resnum C318 .or. -
   atom @ligseg @resnum H322 .or. -
   atom @ligseg @resnum H323 .or. -
   atom @ligseg @resnum S321 .or. -
   atom @ligseg @resnum O324 .or. -
   atom @ligseg @resnum O325 .or. -
   atom @ligseg @resnum C326 .or. -
   atom @ligseg @resnum H327 .or. -
   atom @ligseg @resnum H328 .or. -
   atom @ligseg @resnum H329 .or. -
   atom @ligseg @resnum N330 .or. -
   none ) end

define site2_sub7 - 
   select ( - 
   atom @ligseg @resnum C331 .or. -
   atom @ligseg @resnum H333 .or. -
   atom @ligseg @resnum H334 .or. -
   atom @ligseg @resnum C332 .or. -
   atom @ligseg @resnum H336 .or. -
   atom @ligseg @resnum H337 .or. -
   atom @ligseg @resnum C335 .or. -
   atom @ligseg @resnum H339 .or. -
   atom @ligseg @resnum H340 .or. -
   atom @ligseg @resnum S338 .or. -
   atom @ligseg @resnum O341 .or. -
   atom @ligseg @resnum O342 .or. -
   atom @ligseg @resnum C343 .or. -
   atom @ligseg @resnum H344 .or. -
   atom @ligseg @resnum H345 .or. -
   atom @ligseg @resnum H346 .or. -
   atom @ligseg @resnum N347 .or. -
   none ) end

define site2_sub8 - 
   select ( - 
   atom @ligseg @resnum C348 .or. -
   atom @ligseg @resnum H351 .or. -
   atom @ligseg @resnum C349 .or. -
   atom @ligseg @resnum H354 .or. -
   atom @ligseg @resnum H355 .or. -
   atom @ligseg @resnum C350 .or. -
   atom @ligseg @resnum H356 .or. -
   atom @ligseg @resnum H357 .or. -
   atom @ligseg @resnum C352 .or. -
   atom @ligseg @resnum H359 .or. -
   atom @ligseg @resnum H360 .or. -
   atom @ligseg @resnum C353 .or. -
   atom @ligseg @resnum H361 .or. -
   atom @ligseg @resnum H362 .or. -
   atom @ligseg @resnum S358 .or. -
   atom @ligseg @resnum O363 .or. -
   atom @ligseg @resnum O364 .or. -
   atom @ligseg @resnum N365 .or. -
   none ) end

define site2_sub9 - 
   select ( - 
   atom @ligseg @resnum C366 .or. -
   atom @ligseg @resnum H368 .or. -
   atom @ligseg @resnum H369 .or. -
   atom @ligseg @resnum C367 .or. -
   atom @ligseg @resnum C370 .or. -
   atom @ligseg @resnum H373 .or. -
   atom @ligseg @resnum H374 .or. -
   atom @ligseg @resnum H375 .or. -
   atom @ligseg @resnum C371 .or. -
   atom @ligseg @resnum H376 .or. -
   atom @ligseg @resnum H377 .or. -
   atom @ligseg @resnum H378 .or. -
   atom @ligseg @resnum O372 .or. -
   atom @ligseg @resnum H379 .or. -
   atom @ligseg @resnum N380 .or. -
   none ) end

define site2_sub10 - 
   select ( - 
   atom @ligseg @resnum C381 .or. -
   atom @ligseg @resnum H383 .or. -
   atom @ligseg @resnum H384 .or. -
   atom @ligseg @resnum C382 .or. -
   atom @ligseg @resnum H387 .or. -
   atom @ligseg @resnum O385 .or. -
   atom @ligseg @resnum H389 .or. -
   atom @ligseg @resnum C386 .or. -
   atom @ligseg @resnum H390 .or. -
   atom @ligseg @resnum H391 .or. -
   atom @ligseg @resnum O388 .or. -
   atom @ligseg @resnum H392 .or. -
   atom @ligseg @resnum N393 .or. -
   none ) end

define site2_sub11 - 
   select ( - 
   atom @ligseg @resnum C394 .or. -
   atom @ligseg @resnum H396 .or. -
   atom @ligseg @resnum H397 .or. -
   atom @ligseg @resnum C395 .or. -
   atom @ligseg @resnum N398 .or. -
   atom @ligseg @resnum N399 .or. -
   none ) end

define site2_sub12 - 
   select ( - 
   atom @ligseg @resnum C400 .or. -
   atom @ligseg @resnum H403 .or. -
   atom @ligseg @resnum C401 .or. -
   atom @ligseg @resnum H406 .or. -
   atom @ligseg @resnum H407 .or. -
   atom @ligseg @resnum C402 .or. -
   atom @ligseg @resnum H408 .or. -
   atom @ligseg @resnum H409 .or. -
   atom @ligseg @resnum C404 .or. -
   atom @ligseg @resnum H411 .or. -
   atom @ligseg @resnum H412 .or. -
   atom @ligseg @resnum C405 .or. -
   atom @ligseg @resnum H413 .or. -
   atom @ligseg @resnum H414 .or. -
   atom @ligseg @resnum N410 .or. -
   atom @ligseg @resnum S415 .or. -
   atom @ligseg @resnum O416 .or. -
   atom @ligseg @resnum O417 .or. -
   atom @ligseg @resnum C418 .or. -
   atom @ligseg @resnum H419 .or. -
   atom @ligseg @resnum H420 .or. -
   atom @ligseg @resnum H421 .or. -
   atom @ligseg @resnum N422 .or. -
   none ) end

auto angle dihe  !! do not call after deleting sub-sub terms or loading in water
bomblev -1

! delete angles and dihedrals between alchem groups
set ii = 1
label deletesiteloop
if @ii .le. @nsites then

   set jj = 1
   label delete1loop
   if @jj .le. @nsubs@@ii then

      calc kk = @jj + 1
      label delete2loop
      if @kk .le. @nsubs@@ii then

         dele connectivity sele ( site@{ii}_sub@@jj ) show end sele ( site@{ii}_sub@@kk ) show end
         calc kk = @kk + 1
         goto delete2loop
      endif

      calc jj = @jj + 1
      goto delete1loop
   endif

   calc ii = @ii + 1
   goto deletesiteloop
endif

!! ! System specific deletion (linear groups)
!! dele dihe sele (atom LIG 1 ATOMNAME) show end

!! Load solvent
read sequ pdb name @builddir/solvent.pdb
generate WT00 first none last none setup noangl nodihe
read coor pdb resid name @builddir/solvent.pdb

!! !! Load ions
!! read sequ pdb name @builddir/ions.pdb
!! generate HETA first none last none setup noangl nodihe
!! read coor pdb resid name @builddir/ions.pdb

print coor sele .not. init end

bomblev 0

!! !! Write Initial System to Disk
!! write psf card name patch.psf
!! * patch psf file
!! *
!! write coor pdb card name patch.pdb
!! * patch pdb file
!! *
!! write coor card name patch.crd
!! * patch crd file
!! *

!! Create water box & periodic images
coor stat
crystal define cubic @box @box @box 90. 90. 90.
crystal build cutoff 14 nope 0
image byres xcen 0 ycen 0 zcen 0 sele resn tip3 .or. resn sod .or. resn cla end
image byseg xcen 0 ycen 0 zcen 0 sele .not. ( resn tip3 .or. resn sod .or. resn cla ) end

!! Copy main coords into comp set
cons harm clear
coor copy comp

! LDBI math: for every "pair" there are 5 ldbi's
set ii = 1
set ldbibias = 0
label ldbimathloop
if @ii .le. @nsites then
   calc ldbibias = @ldbibias + ( ( @nsubs@@ii * (@nsubs@@ii - 1) / 2 ) * 5 )
   INCR ii by 1
   goto ldbimathloop
endif
set charge = ?cgtot

calc blockplusone = @nblocks + 1

!! BLOCK setup
BLOCK @blockplusone
   clear
END
BLOCK @blockplusone !RX! NREP @nreps
   Call 2 sele site1_sub1 show end
   Call 3 sele site1_sub2 show end
   Call 4 sele site1_sub3 show end
   Call 5 sele site1_sub4 show end
   Call 6 sele site1_sub5 show end
   Call 7 sele site1_sub6 show end
   Call 8 sele site1_sub7 show end
   Call 9 sele site1_sub8 show end
   Call 10 sele site1_sub9 show end
   Call 11 sele site1_sub10 show end
   Call 12 sele site1_sub11 show end
   Call 13 sele site1_sub12 show end
   Call 14 sele site1_sub13 show end
   Call 15 sele site1_sub14 show end
   Call 16 sele site1_sub15 show end
   Call 17 sele site1_sub16 show end
   Call 18 sele site2_sub1 show end
   Call 19 sele site2_sub2 show end
   Call 20 sele site2_sub3 show end
   Call 21 sele site2_sub4 show end
   Call 22 sele site2_sub5 show end
   Call 23 sele site2_sub6 show end
   Call 24 sele site2_sub7 show end
   Call 25 sele site2_sub8 show end
   Call 26 sele site2_sub9 show end
   Call 27 sele site2_sub10 show end
   Call 28 sele site2_sub11 show end
   Call 29 sele site2_sub12 show end

   qldm theta
   lang temp @temp
if @nreps .gt. 1 then
   phmd ph 7
endif
   soft on   ! this turns on soft-cores
   pmel ex   ! this turns on PME

   ldin 1 1.0  0.0  5.0  0.0  5.0
if @nreps .gt. 1 then
   ldin 2  0.0625 0.0  5.0  @lams1s1 5.0 NONE
   ldin 3  0.0625 0.0  5.0  @lams1s2 5.0 FIX 7.0
   ldin 4  0.0625 0.0  5.0  @lams1s3 5.0 FIX 7.0
   ldin 5  0.0625 0.0  5.0  @lams1s4 5.0 FIX 7.0
   ldin 6  0.0625 0.0  5.0  @lams1s5 5.0 FIX 7.0
   ldin 7  0.0625 0.0  5.0  @lams1s6 5.0 FIX 7.0
   ldin 8  0.0625 0.0  5.0  @lams1s7 5.0 FIX 7.0
   ldin 9  0.0625 0.0  5.0  @lams1s8 5.0 FIX 7.0
   ldin 10 0.0625 0.0  5.0  @lams1s9 5.0 FIX 7.0
   ldin 11 0.0625 0.0  5.0  @lams1s10 5.0 FIX 7.0
   ldin 12 0.0625 0.0  5.0  @lams1s11 5.0 FIX 7.0
   ldin 13 0.0625 0.0  5.0  @lams1s12 5.0 FIX 7.0
   ldin 14 0.0625 0.0  5.0  @lams1s13 5.0 FIX 7.0
   ldin 15 0.0625 0.0  5.0  @lams1s14 5.0 FIX 7.0
   ldin 16 0.0625 0.0  5.0  @lams1s15 5.0 FIX 7.0
   ldin 17 0.0625 0.0  5.0  @lams1s16 5.0 FIX 7.0
   ldin 18 0.0833 0.0  5.0  @lams2s1 5.0 NONE
   ldin 19 0.0833 0.0  5.0  @lams2s2 5.0 FIX 7.0
   ldin 20 0.0833 0.0  5.0  @lams2s3 5.0 FIX 7.0
   ldin 21 0.0833 0.0  5.0  @lams2s4 5.0 FIX 7.0
   ldin 22 0.0833 0.0  5.0  @lams2s5 5.0 FIX 7.0
   ldin 23 0.0833 0.0  5.0  @lams2s6 5.0 FIX 7.0
   ldin 24 0.0833 0.0  5.0  @lams2s7 5.0 FIX 7.0
   ldin 25 0.0833 0.0  5.0  @lams2s8 5.0 FIX 7.0
   ldin 26 0.0833 0.0  5.0  @lams2s9 5.0 FIX 7.0
   ldin 27 0.0833 0.0  5.0  @lams2s10 5.0 FIX 7.0
   ldin 28 0.0833 0.0  5.0  @lams2s11 5.0 FIX 7.0
   ldin 29 0.0833 0.0  5.0  @lams2s12 5.0 FIX 7.0

else
   ldin 2  0.0625 0.0  5.0  @lams1s1 5.0 !RX! NONE
   ldin 3  0.0625 0.0  5.0  @lams1s2 5.0 !RX! UNEG 7.0
   ldin 4  0.0625 0.0  5.0  @lams1s3 5.0 !RX! UPOS 7.0
   ldin 5  0.0625 0.0  5.0  @lams1s4 5.0 !RX! UNEG 7.0
   ldin 6  0.0625 0.0  5.0  @lams1s5 5.0 !RX! UPOS 7.0
   ldin 7  0.0625 0.0  5.0  @lams1s6 5.0 !RX! UNEG 7.0
   ldin 8  0.0625 0.0  5.0  @lams1s7 5.0 !RX! UPOS 7.0
   ldin 9  0.0625 0.0  5.0  @lams1s8 5.0 !RX! UNEG 7.0
   ldin 10 0.0625 0.0  5.0  @lams1s9 5.0 !RX! UPOS 7.0
   ldin 11 0.0625 0.0  5.0  @lams1s10 5.0 !RX! UNEG 7.0
   ldin 12 0.0625 0.0  5.0  @lams1s11 5.0 !RX! UPOS 7.0
   ldin 13 0.0625 0.0  5.0  @lams1s12 5.0 !RX! UNEG 7.0
   ldin 14 0.0625 0.0  5.0  @lams1s13 5.0 !RX! UPOS 7.0
   ldin 15 0.0625 0.0  5.0  @lams1s14 5.0 !RX! UNEG 7.0
   ldin 16 0.0625 0.0  5.0  @lams1s15 5.0 !RX! UPOS 7.0
   ldin 17 0.0625 0.0  5.0  @lams1s16 5.0 !RX! UNEG 7.0
   ldin 18 0.0833 0.0  5.0  @lams2s1 5.0 !RX! NONE
   ldin 19 0.0833 0.0  5.0  @lams2s2 5.0 !RX! UNEG 7.0
   ldin 20 0.0833 0.0  5.0  @lams2s3 5.0 !RX! UPOS 7.0
   ldin 21 0.0833 0.0  5.0  @lams2s4 5.0 !RX! UNEG 7.0
   ldin 22 0.0833 0.0  5.0  @lams2s5 5.0 !RX! UPOS 7.0
   ldin 23 0.0833 0.0  5.0  @lams2s6 5.0 !RX! UNEG 7.0
   ldin 24 0.0833 0.0  5.0  @lams2s7 5.0 !RX! UPOS 7.0
   ldin 25 0.0833 0.0  5.0  @lams2s8 5.0 !RX! UNEG 7.0
   ldin 26 0.0833 0.0  5.0  @lams2s9 5.0 !RX! UPOS 7.0
   ldin 27 0.0833 0.0  5.0  @lams2s10 5.0 !RX! UNEG 7.0
   ldin 28 0.0833 0.0  5.0  @lams2s11 5.0 !RX! UPOS 7.0
   ldin 29 0.0833 0.0  5.0  @lams2s12 5.0 !RX! UNEG 7.0

endif 
   set si = 1
   label ex_si_loop
   if @si .le. @nsites then
      set ii = 1
      label ex_ii_loop
      if @ii .le. @nsubs@@si then
         calc jj = @ii + 1
         label ex_jj_loop
         if @jj .le. @nsubs@@si then
            calc iip1 = @ii + 1
            calc jjp1 = @jj + 1
            adex @iip1 @jjp1
            calc jj = @jj + 1
            goto ex_jj_loop
         endif
         calc ii = @ii + 1
         goto ex_ii_loop
      endif
      calc si = @si + 1
      goto ex_si_loop
   endif

   set excl1 = 2 3 2 4 2 5 2 6 2 7 2 8 2 9 2 10 2 11 2 12 2 13
   set excl2 = 2 14 2 15 2 16 2 17 3 4 3 5 3 6 3 7 3 8 3 9 3 10
   set excl3 = 3 11 3 12 3 13 3 14 3 15 3 16 3 17 4 5 4 6 4 7 4 8
   set excl4 = 4 9 4 10 4 11 4 12 4 13 4 14 4 15 4 16 4 17 5 6 5 7
   set excl5 = 5 8 5 9 5 10 5 11 5 12 5 13 5 14 5 15 5 16 5 17 6 7
   set excl6 = 6 8 6 9 6 10 6 11 6 12 6 13 6 14 6 15 6 16 6 17 7 8
   set excl7 = 7 9 7 10 7 11 7 12 7 13 7 14 7 15 7 16 7 17 8 9 8 10
   set excl8 = 8 11 8 12 8 13 8 14 8 15 8 16 8 17 9 10 9 11 9 12 9 13
   set excl9 = 9 14 9 15 9 16 9 17 10 11 10 12 10 13 10 14 10 15 10 16 10 17
   set excl10 = 11 12 11 13 11 14 11 15 11 16 11 17 12 13 12 14 12 15 12 16 12 17
   set excl11 = 13 14 13 15 13 16 13 17 14 15 14 16 14 17 15 16 15 17 16 17 18 19
   set excl12 = 18 20 18 21 18 22 18 23 18 24 18 25 18 26 18 27 18 28 18 29 19 20
   set excl13 = 19 21 19 22 19 23 19 24 19 25 19 26 19 27 19 28 19 29 20 21 20 22
   set excl14 = 20 23 20 24 20 25 20 26 20 27 20 28 20 29 21 22 21 23 21 24 21 25
   set excl15 = 21 26 21 27 21 28 21 29 22 23 22 24 22 25 22 26 22 27 22 28 22 29
   set excl16 = 23 24 23 25 23 26 23 27 23 28 23 29 24 25 24 26 24 27 24 28 24 29
   set excl17 = 25 26 25 27 25 28 25 29 26 27 26 28 26 29 27 28 27 29 28 29
   excl @excl1 @excl2 @excl3 @excl4 @excl5 @excl6 @excl7 @excl8 @excl9 @excl10 @excl11 @excl12 @excl13 @excl14 @excl15 @excl16 @excl17

   !!rmla bond thet dihe impr 
   rmla bond thet impr 
   msld 0  1  1  1  1  1  1  1  1  1  1  1  1  1  1  1  1  2  2  2  2  2  2  2  2  2  2  2  2  fnex @fnex
   msma

   thbv all auto

!    scat on
!    scat k 118.4
!    cats select ( .bonded. atom @ligseg @resnum C001 ) .and. .not. -
!                ( atom @ligseg @resnum C001 .or. -
!                atom @ligseg @resnum H002 .or. -
!                atom @ligseg @resnum C003 ) show end
!    cats select ( .bonded. atom @ligseg @resnum C003 ) .and. .not. -
!                ( atom @ligseg @resnum C003 .or. -
!                atom @ligseg @resnum H004 .or. -
!                atom @ligseg @resnum C001 ) show end

   ! Check block.doc for functional form of these biasing potentials
   calc nbiaspot = 5 * ( @nblocks * ( @nblocks - 1 ) ) / 2
   ldbi @nbiaspot
   set ibias = 1
   set iblock = 0
   set si = 1
   label loop5_vb
   if @si .le. @nsites then
      set jblock = @iblock
      set sj = @si
      label loop5b_vb
      if @sj .le. @nsites then
         set ii = 1
         label loop6_vb
         if @ii .le. @nsubs@@{si} then
            calc ip1 = @ii + 1 + @iblock
            set jj = 1
            if @si .eq. @sj then
               calc jj = @ii + 1
            endif
            label loop7_vb
            if @jj .le. @nsubs@@{sj} then
               calc jp1 = @jj + 1 + @jblock
   
               set c_shift = 0.0
               set x_shift = 0.0
               set s_shift = 0.0
               !vbrex! if @si .eq. @sj then
               !vbrex!    calc c_shift = 1.2 * (@myrep - @ncentral)
               !vbrex!    calc s_shift = 0.3 * (@myrep - @ncentral)
               !vbrex! endif
   
               calc coeff = @cs@@{si}s@@{ii}s@@{sj}s@@{jj} + @{c_shift}
               ldbv @ibias @ip1 @jp1 6 0.0 @coeff 0
               calc ibias = @ibias + 1
               calc coeff = @xs@@{si}s@@{ii}s@@{sj}s@@{jj} + @{x_shift}
               ldbv @ibias @ip1 @jp1 10 -5.56 @coeff 0
               calc ibias = @ibias + 1
               calc coeff = @ss@@{si}s@@{ii}s@@{sj}s@@{jj} + @{s_shift}
               ldbv @ibias @ip1 @jp1 8 0.017 @coeff 0
               calc ibias = @ibias + 1
               calc coeff = @xs@@{sj}s@@{jj}s@@{si}s@@{ii} + @{x_shift}
               ldbv @ibias @jp1 @ip1 10 -5.56 @coeff 0
               calc ibias = @ibias + 1
               calc coeff = @ss@@{sj}s@@{jj}s@@{si}s@@{ii} + @{s_shift}
               ldbv @ibias @jp1 @ip1 8 0.017 @coeff 0
               calc ibias = @ibias + 1
               calc jj = @jj + 1
               goto loop7_vb
            endif
            calc ii = @ii + 1
            goto loop6_vb
         endif
         calc jblock = @jblock + @nsubs@@{sj}
         calc sj = @sj + 1
         goto loop5b_vb
      endif
      calc iblock = @iblock + @nsubs@@{si}
      calc si = @si + 1
      goto loop5_vb
   endif
END

!! !! Set NOE distance restraints
!! NOE
!!    RESET
!! END
!! 
!! faster on
!! !! set up energy parameters if you want to use NOEs
!! nbonds atom fswitch vdw vfswitch cdie eps 1 -
!!     cutnb 14.0 cutim 14.0 ctonnb 10.0 ctofnb 12.0

!! energy
!! NOE
!! ! Site 1
!!    assign sele atom LIG 1 Atom1 end sele atom LIG 1 Atom2 end -
!!    kmin 1.0 rmin 0.0 kmax 1.0 rmax 0.2 fmax 2.0 rswitch 2.0 sexp 1.0
!! ! Site 2
!!    assign sele atom LIG 1 Atom1 end sele atom LIG 1 Atom2 end -
!!    kmin 1.0 rmin 0.0 kmax 1.0 rmax 0.2 fmax 2.0 rswitch 2.0 sexp 1.0
!! 
!!    print anal
!! END


